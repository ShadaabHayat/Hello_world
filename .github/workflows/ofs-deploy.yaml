name: Deploy Online Feature Store

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: local
        type: choice
        options:
          - local
          - prod
          - sandbox
          - staging
          - ws2-aicore
      image_tag:
        description: 'Image tag to update (e.g., v0.0.6)'
        required: false
        type: string

defaults:
  run:
    shell: bash

jobs:
  Deployment:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set environment file name
        id: set_env
        run: |
          echo "ENV_FILE=helm-chart/values-${{ github.event.inputs.environment }}.yaml" >> $GITHUB_ENV

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq
          yq --version  # Confirm it's installed
      
      - name: Update image tag without changing format
        run: |
          yq e --inplace --prettyPrint=false '.image.tag = "v${{ github.event.inputs.image_tag }}"' $ENV_FILE
      
      # - name: Update image tag in ${{ env.ENV_FILE }}
      #   uses: mikefarah/yq@master
      #   with:
      #     cmd: |
      #       yq e -i '.image.tag = "v${{ inputs.image_tag }}"' $ENV_FILE

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add $ENV_FILE
          git commit -m "Update image tag to ${{ github.event.inputs.image_tag }} for ${{ github.event.inputs.environment }}"
          git push
